-- Hava Durumu Cache Tablosu
CREATE TABLE WeatherCache (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    CityName NVARCHAR(50) NOT NULL,
    CityId INT NOT NULL,
    WeatherData NVARCHAR(MAX) NOT NULL,
    LastUpdated DATETIME NOT NULL DEFAULT GETDATE(),
    CONSTRAINT UQ_CityName UNIQUE(CityName)
)

-- Index oluştur (performans için)
CREATE INDEX IX_WeatherCache_CityName ON WeatherCache(CityName)
CREATE INDEX IX_WeatherCache_LastUpdated ON WeatherCache(LastUpdated)

=======================================================================

Veritabanında invalid değerleri (kodla uyumsuz olanları) SQL scriptleriyle temizle.(Personel) Sendika=Yok gibi.
Önce localde yap,sonra gerçek veritabanında.

=======================================================================

FIRMALAR, DENETIMLER Tablolarında ID otomatik artmadığı için kodda sorun yaşanıyor, 
yeni veritabanına geçerken o alanların otomatik arttığından emin ol.

=======================================================================
 BelgeTakip projesinden gelen Personel Tablosunu DenetimPersonel olarak değiştirerek ankarabolge veritaanına ekledim.
 Canlıya alırkende aynı yöntem izlenecek.
 =======================================================================

-- ==========================================
-- KULLANICI PAROLA HASHLEME - SQL SCRIPT
-- Tüm kullanıcıların parolası: Ankara2025!
-- ==========================================

-- 1. YEDEK KONTROL (Zaten aldınız ama kontrol edelim)
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'kullanici_yedek')
BEGIN
    SELECT * INTO kullanici_yedek FROM kullanici;
    PRINT 'Yedek alındı: kullanici_yedek tablosu oluşturuldu';
END
ELSE
BEGIN
    PRINT 'Yedek tablosu zaten mevcut';
END
GO

-- 2. Parola kolonunu genişlet
ALTER TABLE kullanici 
ALTER COLUMN Parola VARCHAR(200) NULL;
PRINT 'Parola kolonu VARCHAR(200) olarak güncellendi';
GO

-- 3. Yeni kolonları ekle (eğer yoksa)
IF NOT EXISTS (SELECT * FROM sys.columns 
               WHERE object_id = OBJECT_ID('kullanici') 
               AND name = 'SifreDegistirmeZorla')
BEGIN
    ALTER TABLE kullanici 
    ADD SifreDegistirmeZorla BIT DEFAULT 0;
    PRINT 'SifreDegistirmeZorla kolonu eklendi';
END
GO

IF NOT EXISTS (SELECT * FROM sys.columns 
               WHERE object_id = OBJECT_ID('kullanici') 
               AND name = 'SonSifreDegistirmeTarihi')
BEGIN
    ALTER TABLE kullanici 
    ADD SonSifreDegistirmeTarihi DATETIME NULL;
    PRINT 'SonSifreDegistirmeTarihi kolonu eklendi';
END
GO

-- 4. TÜM KULLANICILARIN PAROLASINI HASHLE   ÖNEMLİ NOT: BU KISMI ATLA- HASHLEME ÖZELLİĞİ ÇALIŞMIYOR
-- SHA256("Ankara2025!") = 188f222d9a55e0a7afe9010244809cf0776b16c8477a6b82bd570a12dfaeb567
UPDATE kullanici 
SET Parola = '188f222d9a55e0a7afe9010244809cf0776b16c8477a6b82bd570a12dfaeb567',
    SifreDegistirmeZorla = 1,
    SonSifreDegistirmeTarihi = GETDATE();

PRINT 'Tüm kullanıcıların parolası hashlendi';
GO

-- 5. KONTROL: Güncellenen kayıt sayısı
SELECT 
    COUNT(*) AS ToplamKullanici,
    SUM(CASE WHEN LEN(Parola) = 64 THEN 1 ELSE 0 END) AS HashliKullanici,
    SUM(CASE WHEN SifreDegistirmeZorla = 1 THEN 1 ELSE 0 END) AS SifreDegistirmesiGerekenler
FROM kullanici;
GO

-- 6. Örnek kullanıcı kontrol
SELECT TOP 5 
    Sicil_No, 
    Adi_Soyadi, 
    LEFT(Parola, 20) + '...' AS ParolaHash,
    LEN(Parola) AS ParolaUzunluk,
    SifreDegistirmeZorla,
    Durum
FROM kullanici
ORDER BY Adi_Soyadi;

============================================

ALTER TABLE duyuru ADD Guncelleme_Tarihi datetime NULL;
ALTER TABLE duyuru ADD Guncelleyen_Kullanici nvarchar(90) NULL;

===========================================

-- Bilgisayar Adları Tablosu
CREATE TABLE bilgisayar_adlari (
    id INT IDENTITY(1,1) PRIMARY KEY,
    domain_no NVARCHAR(50) NOT NULL,
    kisi_adi NVARCHAR(150) NULL,
    bilgisayar_tipi NVARCHAR(150) NULL,
    dahili_no NVARCHAR(20) NULL,
    
    -- Audit alanları
    kayit_tarihi DATETIME DEFAULT GETDATE(),
    kayit_kullanici NVARCHAR(100) NULL,
    guncelleme_tarihi DATETIME NULL,
    guncelleyen_kullanici NVARCHAR(100) NULL,
    
    CONSTRAINT UK_bilgisayar_domain UNIQUE(domain_no)
);

-- İndeks ekle (arama performansı için)
CREATE INDEX IX_bilgisayar_kisi ON bilgisayar_adlari(kisi_adi);
CREATE INDEX IX_bilgisayar_domain ON bilgisayar_adlari(domain_no);

GO

==========================================

Merhaba, evet bu SQL Server'da (MSSQL) UPDATE ve REPLACE fonksiyonları kullanarak toplu olarak yapılabilir.

İstediğiniz işlemi gerçekleştirmek için aşağıdaki SQL sorgu yapısını kullanabilirsiniz.

⚠️ Çok Önemli Uyarılar
Veritabanında toplu güncelleme (UPDATE) yapmak riskli bir işlemdir. Lütfen başlamadan önce:

VERİTABANINIZIN YEDEĞİNİ ALIN.

Sorguyu önce bir test ortamında veya SELECT ile deneyerek sonuçları görün.

1. Adım: Değişiklikleri Test Etme (SELECT)
Güncelleme yapmadan önce, hangi kayıtların nasıl değişeceğini görmek için bir SELECT sorgusu çalıştırın. Bu sorgu hiçbir veriyi değiştirmez, sadece size bir önizleme sunar.

TabloAdiniz ve DosyaYoluKolonunuz kısımlarını kendi tablonuzdaki isimlerle değiştirin.

SQL

SELECT
    DosyaYoluKolonunuz AS OrjinalYol,
    REPLACE(DosyaYoluKolonunuz, '~/arsiv/', '~/Uploads/Arsiv/') AS YeniYol
FROM
    TabloAdiniz
WHERE
    DosyaYoluKolonunuz LIKE '~/arsiv/%';
REPLACE(Kolon, 'bul', 'değiştir'): Bu fonksiyon, kolondaki '~/arsiv/' metnini bulur ve onu '~/Uploads/Arsiv/' ile değiştirir.

WHERE ... LIKE '~/arsiv/%': Bu kısım, sadece ilgili dosya yollarına sahip kayıtları işleme almanızı sağlar. Bu, sorgunun daha hızlı çalışmasını ve yanlış kayıtları hedef almamasını garanti eder.

2. Adım: Verileri Güncelleme (UPDATE)
SELECT sorgusunun çıktısı tam olarak istediğiniz gibiyse, UPDATE sorgusunu çalıştırabilirsiniz.

Güvenlik için bu işlemi bir Transaction (İşlem) bloğu içinde yapmanızı tavsiye ederim. Bu sayede, eğer bir hata olursa veya beklediğinizden farklı sayıda satır güncellenirse, işlemi geri alabilirsiniz (ROLLBACK).

SQL

-- Değişikliklerinizin güvende olması için bir işlem başlatın
BEGIN TRAN;

UPDATE TabloAdiniz
SET
    DosyaYoluKolonunuz = REPLACE(DosyaYoluKolonunuz, '~/arsiv/', '~/Uploads/Arsiv/')
WHERE
    DosyaYoluKolonunuz LIKE '~/arsiv/%';

-- Kaç satırın güncellendiğini kontrol edin
PRINT CAST(@@ROWCOUNT AS VARCHAR) + ' satır güncellendi.';

-- EĞER HER ŞEY YOLUNDAYSA VE SONUÇTAN EMİNSENİZ:
-- İşlemi kalıcı hale getirmek için aşağıdaki satırın başındaki -- işaretini kaldırın
-- COMMIT TRAN;


-- EĞER BİR SORUN VARSA VEYA GERİ ALMAK İSTİYORSANIZ:
-- İşlemi geri almak için aşağıdaki satırın başındaki -- işaretini kaldırın
-- ROLLBACK TRAN;
Nasıl Kullanılır:

Yukarıdaki sorguyu kopyalayıp SQL Server Management Studio (SSMS) veya kullandığınız veritabanı aracına yapıştırın.

TabloAdiniz ve DosyaYoluKolonunuz adlarını düzeltin.

Sorguyu BEGIN TRAN; satırından PRINT... satırına kadar çalıştırın.

Aşağıdaki "Messages" (Mesajlar) sekmesinde "X satır güncellendi" mesajını göreceksiniz.

Emin olmak için 1. Adım'daki SELECT sorgusunu tekrar çalıştırın (veya SELECT * FROM TabloAdiniz WHERE ... yapın). 
Verilerin yeni halini göreceksiniz.

Her şey doğruysa, COMMIT TRAN; komutunu tek başına seçip çalıştırın. Değişiklikler kalıcı olacaktır.

Bir hata yaptıysanız, ROLLBACK TRAN; komutunu tek başına seçip çalıştırın. Her şey eski haline dönecektir.

===========================================================================

-- Yeni tablo oluştur: sistem_parametreleri
CREATE TABLE [dbo].[sistem_parametreleri](
    [id] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY,
    [Parametre_Adi] [nvarchar](100) NOT NULL,
    [Parametre_Degeri] [nvarchar](500) NULL,
    [Aciklama] [nvarchar](max) NULL,
    [Kayit_Tarihi] [datetime] DEFAULT GETDATE(),
    [Guncelleyen] [nvarchar](100) NULL,
    [Guncelleme_Tarihi] [datetime] NULL
);

-- İlk parametre kaydını ekle
INSERT INTO sistem_parametreleri 
    (Parametre_Adi, Parametre_Degeri, Aciklama)
VALUES 
    ('OZEL_KULLANICI_ADI', 'Kemal YILMAZ', 'Özel yetkilere sahip kullanıcı adı');

    =======================================================================

    INSERT INTO sistem_parametreleri (Parametre_Adi, Parametre_Degeri, Aciklama)
VALUES 
    ('DOSYA_MAX_BOYUT_MB', '10', 'Maksimum dosya yükleme boyutu (MB)'),
    ('SESSION_TIMEOUT_DAKIKA', '30', 'Oturum zaman aşımı süresi');

    ========================================================================

    -- gorevkayit tablosuna Vergi_Numarasi kolonu ekleme
ALTER TABLE gorevkayit 
ADD Vergi_Numarasi NVARCHAR(50) NULL;

================================================================================

CREATE TABLE PerformanceLogs (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    PageName NVARCHAR(200) NOT NULL,
    LoadTimeMs INT NOT NULL,
    SqlQueryCount INT DEFAULT 0,
    MemoryUsageMB DECIMAL(10,2) DEFAULT 0,
    UserSicil NVARCHAR(50),
    UserName NVARCHAR(200),
    CreatedDate DATETIME DEFAULT GETDATE(),
    
    INDEX IX_PageName (PageName),
    INDEX IX_CreatedDate (CreatedDate)
);

=================================================================================

USE [ankarabolge]
GO

/****** Object:  Index [IX_arsiv_Unet]    Script Date: 24.11.2025 ******/
CREATE NONCLUSTERED INDEX [IX_arsiv_Unet]
ON [dbo].[arsiv] ([Unet]);
GO
=================================================================================

USE [ankarabolge]
GO

/* 1. TABLO: tmistatistik
   Etki: %88.67
   Açıklama: İstatistiklerde İl ve Duruma göre (Örn: Ankara'daki Aktif firmalar) yapılan aramaları hızlandırır. */
CREATE NONCLUSTERED INDEX [IX_tmistatistik_il_Durum]
ON [dbo].[tmistatistik] ([il], [Durum]);
GO

/* 2. TABLO: denetimisletme
   Etki: %74.68
   Açıklama: Denetimlerde İl ve İlçe hiyerarşisine göre yapılan filtrelemeleri hızlandırır. */
CREATE NONCLUSTERED INDEX [IX_denetimisletme_il_ilce]
ON [dbo].[denetimisletme] ([il], [ilce]);
GO

/* 3. TABLO: personel_izin
   Etki: %23.22
   Açıklama: Personelin (Sicil No) belirli bir izin türündeki kayıtlarını (Örn: Yıllık İzin) bulmayı hızlandırır. */
CREATE NONCLUSTERED INDEX [IX_personel_izin_SicilNo_izinturu]
ON [dbo].[personel_izin] ([Sicil_No], [izin_turu]);
GO

=======================================================================================

